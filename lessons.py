from google_sheets import append_student
from datetime import datetime


def process_lesson_message(teacher_name, message_text):
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–Ω—è—Ç–∏–∏ –æ—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
    
    –§–æ—Ä–º–∞—Ç —Å–æ–æ–±—â–µ–Ω–∏—è: "–§–∞–º–∏–ª–∏—è –ò–º—è [–∫–ª–∞—Å—Å] / –ø—Ä–∏–º–µ—á–∞–Ω–∏—è"
    –ü—Ä–∏–º–µ—Ä—ã:
    - "–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä 5"
    - "–ò–≤–∞–Ω–æ–≤–∞ –ê–Ω–Ω–∞ 7 / —Ö–æ—Ä–æ—à–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∞—Å—å"
    - "–°–∏–¥–æ—Ä–æ–≤ –ò–≤–∞–Ω / –ø—Ä–æ–ø—É—Å—Ç–∏–ª –∑–∞–Ω—è—Ç–∏–µ"
    """
    try:
        # –†–∞–∑–¥–µ–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–Ω—É—é —á–∞—Å—Ç—å –∏ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è
        if "/" in message_text:
            student_info, note = map(str.strip, message_text.split("/", 1))
        else:
            student_info, note = message_text.strip(), ""

        # –†–∞–∑–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—á–µ–Ω–∏–∫–µ
        parts = student_info.split()
        if len(parts) < 2:
            return "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –ù—É–∂–Ω–æ: –§–∞–º–∏–ª–∏—è –ò–º—è [–∫–ª–∞—Å—Å —Ü–∏—Ñ—Ä–æ–π] / –ø—Ä–∏–º–µ—á–∞–Ω–∏—è\n\n–ü—Ä–∏–º–µ—Ä—ã:\n‚Ä¢ –ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä 5\n‚Ä¢ –ò–≤–∞–Ω–æ–≤–∞ –ê–Ω–Ω–∞ 7 / —Ö–æ—Ä–æ—à–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∞—Å—å"

        # –ò–∑–≤–ª–µ–∫–∞–µ–º –§–ò–û –∏ –∫–ª–∞—Å—Å
        student_name = " ".join(parts[:2])  # –§–∞–º–∏–ª–∏—è –ò–º—è
        student_class = parts[2] if len(parts) > 2 else ""  # –ö–ª–∞—Å—Å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–ª–∞—Å—Å–∞ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω)
        if student_class and not student_class.isdigit():
            return "‚ùå –ö–ª–∞—Å—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω —Ü–∏—Ñ—Ä–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä: 5, 7, 11)"

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ DD.MM.YYYY
        date = datetime.now().strftime("%d.%m.%Y")

        # –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü—É
        success = append_student(teacher_name, student_name, student_class, date, note)
        
        if success:
            # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            response = f"‚úÖ –ó–∞–ø–∏—Å—å –¥–æ–±–∞–≤–ª–µ–Ω–∞:\n"
            response += f"üë§ –£—á–µ–Ω–∏–∫: {student_name}\n"
            if student_class:
                response += f"üìö –ö–ª–∞—Å—Å: {student_class}\n"
            response += f"üìÖ –î–∞—Ç–∞: {date}\n"
            if note:
                response += f"üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: {note}"
            
            return response
        else:
            return "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."
            
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
        return "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑."


def validate_student_name(name):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∏–º–µ–Ω–∏ —É—á–µ–Ω–∏–∫–∞"""
    if not name or len(name.strip()) < 3:
        return False, "–ò–º—è —É—á–µ–Ω–∏–∫–∞ –¥–æ–ª–∂–Ω–æ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞"
    
    parts = name.split()
    if len(parts) < 2:
        return False, "–£–∫–∞–∂–∏—Ç–µ –§–∞–º–∏–ª–∏—é –∏ –ò–º—è —É—á–µ–Ω–∏–∫–∞"
    
    return True, ""


def validate_class(class_num):
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –Ω–æ–º–µ—Ä–∞ –∫–ª–∞—Å—Å–∞"""
    if not class_num:
        return True, ""  # –ö–ª–∞—Å—Å –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
    
    if not class_num.isdigit():
        return False, "–ö–ª–∞—Å—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–∫–∞–∑–∞–Ω —Ü–∏—Ñ—Ä–æ–π"
    
    class_int = int(class_num)
    if class_int < 1 or class_int > 11:
        return False, "–ö–ª–∞—Å—Å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 11"
    
    return True, ""
