#!/usr/bin/env python3
"""
–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ Google Sheets.
–¢–†–ï–ë–£–ï–¢ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –≤ .env –∏ –¥–æ—Å—Ç—É–ø–∞ —Å–µ—Ä–≤–∏—Å-–∞–∫–∫–∞—É–Ω—Ç–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ.

–®–∞–≥–∏:
1) –î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –≤ –ª–∏—Å—Ç "–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏" (—Å—Ç—Ä–æ–∫–∞ 4, –µ—Å–ª–∏ –ø—É—Å—Ç–æ)
2) –°–æ–∑–¥–∞–µ—Ç –≤–∫–ª–∞–¥–∫—É –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –ø–æ —à–∞–±–ª–æ–Ω—É
3) –î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–ø–∏—Å—å –∑–∞–Ω—è—Ç–∏—è (—É—á–µ–Ω–∏–∫, –¥–∞—Ç–∞, –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ)
4) –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–Ω–∞—á–µ–Ω–∏—è –≤ —è—á–µ–π–∫–∞—Ö
5) –£–¥–∞–ª—è–µ—Ç —Ç–µ—Å—Ç–æ–≤—É—é –≤–∫–ª–∞–¥–∫—É –∏ —Å—Ç—Ä–æ–∫—É –∏–∑ "–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏"
"""

import os
from dotenv import load_dotenv
from datetime import datetime
import gspread
from google.oauth2.service_account import Credentials

from google_sheets import (
    get_spreadsheet,
    get_admin_sheet,
    create_teacher_sheet,
    get_teacher_sheet,
    append_student,
    get_date_column
)

TEST_TEACHER = {
    "–§–ò–û": "–¢–µ—Å—Ç–æ–≤—ã–π –ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å QA",
    "–¢–µ–ª–µ—Ñ–æ–Ω": "+79990000000",
    "Telegram ID": 999000111,
    "Username": "qa_teacher",
    "–ü—Ä–µ–¥–º–µ—Ç": "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞",
    "–ö–ª–∞—Å—Å—ã": "—Å—Ä–µ–¥–Ω–∏–µ, —Å—Ç–∞—Ä—à–∏–µ",
}


def ensure_admin_row(sheet, teacher):
    values = sheet.get_all_values()
    
    # –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—É—é –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –Ω–∞—á–∏–Ω–∞—è —Å 4-–π
    insert_row_index = 4
    for i in range(3, len(values)):  # –ù–∞—á–∏–Ω–∞–µ–º —Å –∏–Ω–¥–µ–∫—Å–∞ 3 (4-—è —Å—Ç—Ä–æ–∫–∞)
        if len(values[i]) == 0 or not values[i][0].strip():  # –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –ø—É—Å—Ç–∞—è
            insert_row_index = i + 1  # gspread –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 1-based –∏–Ω–¥–µ–∫—Å—ã
            break
    else:
        # –ï—Å–ª–∏ –≤—Å–µ —Å—Ç—Ä–æ–∫–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω—ã, –¥–æ–±–∞–≤–ª—è–µ–º –≤ –∫–æ–Ω–µ—Ü
        insert_row_index = len(values) + 1
    
    row = [
        teacher["–§–ò–û"],
        teacher["–¢–µ–ª–µ—Ñ–æ–Ω"],
        teacher["Telegram ID"],
        teacher["Username"],
        teacher["–ü—Ä–µ–¥–º–µ—Ç"],
        teacher["–ö–ª–∞—Å—Å—ã"],
        datetime.now().strftime("%d.%m.%Y"),
    ]
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º insert_row —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –≤ —Å–µ—Ä–µ–¥–∏–Ω—É, –∏–Ω–∞—á–µ append_row
    if insert_row_index <= len(values):
        sheet.insert_row(row, index=insert_row_index)
    else:
        sheet.append_row(row)
    
    return insert_row_index


def main():
    load_dotenv()

    # –®–∞–≥ 1: –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –≤ –∞–¥–º–∏–Ω-–ª–∏—Å—Ç
    admin = get_admin_sheet()
    admin_row = ensure_admin_row(admin, TEST_TEACHER)
    print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –≤ '–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏': {admin_row}")

    # –®–∞–≥ 2: –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫—É –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
    sheet = create_teacher_sheet(TEST_TEACHER["–§–ò–û"])
    if not sheet:
        raise SystemExit("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≤–∫–ª–∞–¥–∫—É –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è")
    print(f"‚úÖ –°–æ–∑–¥–∞–Ω –ª–∏—Å—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è: {sheet.title}")

    # –®–∞–≥ 3: –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å–∏ —É—á–µ–Ω–∏–∫–æ–≤ (—Ç–µ—Å—Ç–∏—Ä—É–µ–º –Ω–æ–≤—É—é –ª–æ–≥–∏–∫—É)
    today = datetime.now().strftime("%d.%m.%Y")
    
    # –¢–µ—Å—Ç 1: –£—á–µ–Ω–∏–∫ –±–µ–∑ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–µ–ª–µ–Ω—ã–º)
    ok1 = append_student(TEST_TEACHER["–§–ò–û"], "–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä", "5", "–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞", today, note="")
    if not ok1:
        raise SystemExit("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å —É—á–µ–Ω–∏–∫–∞ –±–µ–∑ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è")
    print("‚úÖ –ó–∞–ø–∏—Å—å —É—á–µ–Ω–∏–∫–∞ –±–µ–∑ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞ (–∑–µ–ª–µ–Ω—ã–π)")
    
    # –¢–µ—Å—Ç 2: –£—á–µ–Ω–∏–∫ —Å –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ–º (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∫—Ä–∞—Å–Ω—ã–º)
    ok2 = append_student(TEST_TEACHER["–§–ò–û"], "–ò–≤–∞–Ω–æ–≤–∞ –ê–Ω–Ω–∞", "7", "—Ñ–∏–∑–∏–∫–∞", today, note="–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç")
    if not ok2:
        raise SystemExit("–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å —É—á–µ–Ω–∏–∫–∞ —Å –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ–º")
    print("‚úÖ –ó–∞–ø–∏—Å—å —É—á–µ–Ω–∏–∫–∞ —Å –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ–º –¥–æ–±–∞–≤–ª–µ–Ω–∞ (–∫—Ä–∞—Å–Ω—ã–π)")

    # –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ –ª–∏—Å—Ç–µ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è
    sheet = get_teacher_sheet(TEST_TEACHER["–§–ò–û"])  # –ø–æ–ª—É—á–∏—Ç—å —Å–≤–µ–∂–∏–π –æ–±—ä–µ–∫—Ç

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —à–∞–ø–∫–∏: B2 = –§–ò–û, B3 = –¢–µ–ª–µ—Ñ–æ–Ω (–ø–æ —Ç–µ–∫—É—â–µ–º—É —à–∞–±–ª–æ–Ω—É)
    fio_cell = sheet.acell("B2").value
    phone_cell = sheet.acell("B3").value
    assert fio_cell == TEST_TEACHER["–§–ò–û"], f"–û–∂–∏–¥–∞–ª–æ—Å—å –§–ò–û –≤ B2: {TEST_TEACHER['–§–ò–û']}, –ø–æ–ª—É—á–µ–Ω–æ: {fio_cell}"
    assert phone_cell == TEST_TEACHER["–¢–µ–ª–µ—Ñ–æ–Ω"], f"–û–∂–∏–¥–∞–ª—Å—è —Ç–µ–ª–µ—Ñ–æ–Ω –≤ B3: {TEST_TEACHER['–¢–µ–ª–µ—Ñ–æ–Ω']}, –ø–æ–ª—É—á–µ–Ω–æ: {phone_cell}"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–º–µ—Ç–æ–∫ –ø–æ –¥–∞—Ç–µ
    date_col = get_date_column(sheet, today)
    assert date_col, f"–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ –¥–ª—è –¥–∞—Ç—ã {today}"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—á–µ–Ω–∏–∫–∞ –±–µ–∑ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è (–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä)
    all_values = sheet.get_all_values()
    petrov_row = None
    ivanova_row = None
    
    for i in range(7, len(all_values)):
        if len(all_values[i]) > 0 and all_values[i][0].startswith("–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä 5 –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞"):
            petrov_row = i + 1
        elif len(all_values[i]) > 0 and all_values[i][0].startswith("–ò–≤–∞–Ω–æ–≤–∞ –ê–Ω–Ω–∞ 7 —Ñ–∏–∑–∏–∫–∞"):
            ivanova_row = i + 1
    
    assert petrov_row, "–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —É—á–µ–Ω–∏–∫–∞ –ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä"
    assert ivanova_row, "–ù–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —É—á–µ–Ω–∏–∫–∞ –ò–≤–∞–Ω–æ–≤–∞ –ê–Ω–Ω–∞"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ü–µ—Ç—Ä–æ–≤–∞ (–±–µ–∑ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å "–¥–∞")
    petrov_mark = sheet.cell(petrov_row, date_col).value
    assert petrov_mark == "–¥–∞", f"–û—Ç–º–µ—Ç–∫–∞ –ü–µ—Ç—Ä–æ–≤–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å '–¥–∞', –ø–æ–ª—É—á–µ–Ω–æ: {petrov_mark}"

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ò–≤–∞–Ω–æ–≤—É (—Å –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ–º - –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å–∞–º–æ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ)
    ivanova_mark = sheet.cell(ivanova_row, date_col).value
    assert ivanova_mark == "–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç", f"–û—Ç–º–µ—Ç–∫–∞ –ò–≤–∞–Ω–æ–≤–æ–π –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ–º, –ø–æ–ª—É—á–µ–Ω–æ: {ivanova_mark}"

    print("‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Å—Ç–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ")

    # –®–∞–≥ 5: –û—á–∏—Å—Ç–∫–∞ ‚Äî —É–¥–∞–ª–∏–º –≤–∫–ª–∞–¥–∫—É –∏ —Å—Ç—Ä–æ–∫—É –≤ –∞–¥–º–∏–Ω-–ª–∏—Å—Ç–µ
    ss = get_spreadsheet()
    ws = get_teacher_sheet(TEST_TEACHER["–§–ò–û"])
    if ws:
        ss.del_worksheet(ws)
        print("üßπ –£–¥–∞–ª–µ–Ω –ª–∏—Å—Ç –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è")

    admin.delete_rows(admin_row)
    print("üßπ –£–¥–∞–ª–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è –∏–∑ '–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏'")

    print("üéâ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ")


if __name__ == "__main__":
    main() 